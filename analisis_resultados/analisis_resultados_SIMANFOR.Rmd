---
title: "Análisis visual de los resultados de SIMANFOR"
author: "Aitor Vázquez Veloso"
date: "2024-03-08"
output: html_document
editor_options: 
  markdown: 
    wrap: 120
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Consideraciones iniciales

Este script ha sido elaborado en:

- SO: Linux
- Encoding: UTF-8
- R: versión 4.2.1


## Resumen del contenido

A lo largo de este documento seguiremos unos pasos sencillos para realizar gráficos con los resultados obtenidos de 
SIMANFOR.

Este documento tiene tres partes principales: 
- la primera parte permite hacer una adaptación de los datos para ver la evolución de nuestra masa forestal a lo largo 
del escenario selvícola. El resultado gráfico es la evolución de la masa que tenemos en nuestro monte, sin tener en 
cuenta la que extraemos con las cortas 
- la segunda parte permite hacer una adaptación de los datos para ver la cantidad de madera acumulada a lo largo de los
escenarios selvícolas. El resultado gráfico es la cantidad de madera total que obtenemos de nuestra masa, incluyendo la 
extraída con las cortas 
- la tercera parte maneja los datos para calcular la cantidad de madera total que obtenemos de nuestra masa, incluyendo 
la extraída con las cortas y los árboles muertos. Este proceso se realiza para algunas variables de referencia como 
el volumen o la biomasa, pero adaptando el código puedes hacerlo para cualquier otra variable que te interese.

Si ya has utilizado R anteriormente, entonces puedes saltar al siguiente apartado, pero si eres nuevo, déjame que 
te explique: 
- las líneas que empiezan con un "\#", son comentarios. R no los interpreta, lo que permite escribir todo lo que 
quieras sin temor a tener errores en el código. Además, este tipo de archivo que estás utilizando (RMarkdown) permite 
intercalar texto explicativo y código de R, sin necesidad de preceder a este texto explicativo de un '\#' 
- las líneas que NO comienzan con \# son las líneas de código que se ejecutan. Debes ir revisando los comentarios para 
saber qué estas haciendo y ejecutando cada bloque de código 
- R tiene algunas funciones integradas por defecto, pero necesitaremos funciones extra (llamadas librerías), que nos 
permitan tener otras utilidades más avanzadas, como por ejemplo hacer gráficos complejos 
- lee los comentarios que he ido poniendo durante el script para saber qué estás haciendo en casa paso


## Índice de contenidos

-   Carga de librerías
-   Carga de datos
-   Preparación de datos: evolución de la masa
-   Cálculo de la evolución promedio de las parcelas para cada escenario
-   Graficar resultados: Densidad y área basimétrica
-   Graficar resultados: Volúmenes comerciales
-   Preparación de datos: madera acumulada
-   Graficar resultados: Área basimétrica y Volumen acumulado
-   Preparación de datos: madera total del itinerario selvícola (en pie
    y extraída)
-   Graficar resultados: producción total durante el escenario selvícola
    (madera en pie + extraída)


## Carga de librerías

Instalamos las librerías necesarias...

```{r}
# si no tienes las siguientes librerías instaladas, entonces ejecuta las 6 líneas siguientes 
# para hacerlo, borra la '#' que precede a cada línea
#install.packages('knitr')
#install.packages('plyr')
#install.packages('dplyr')
#install.packages('ggplot2')
#install.packages("readxl")
```

y las cargamos para poder utilizarlas con R.

```{r warning=FALSE}
# una vez instaladas, vamos a cargarlas en R para poder utilizarlas
library(readxl)
library(plyr)
library(dplyr)
library(ggplot2)
```


## Carga de datos

Para que funcione el siguiente código debes introducir la ruta de la carpeta en la que tienes alojados los resultados 
de SIMANFOR. No importa si dentro de la carpeta que indicas tienes subcarpetas, el código se encargará de acceder a 
todas ellas y extraer la información de los archivos en formato .xlsx.

```{r}
# introduce la ruta de la carpeta en la que tienes alojados los resultados de SIMANFOR
# OJO! no olvides que en R las rutas se escriben con '/' y no con '\' como en Windows
# por ejemplo, my_path <- 'C:/Usuarios/mi_usuario/Descargas'
my_path <- '/home/aitor/Downloads/resultados/Ps-no_maderables'
```

En este apartado vamos acceder a todos los archivos de resultados de SIMANFOR, extrayendo su información Para ello, 
vamos a hacer un bucle "for": <https://r-coder.com/for-en-r/> 
Esto nos permitirá recorrer todos los archivos, y con código auxiliar importaremos la información que queremos en R

```{r}
# variable que contendrá la información de parcelas
plots <- data.frame()

# variable que contendrá los nombres de las subcarpetas
directory <- list.dirs(path = my_path)  

# para cada carpeta dentro del directorio...
for(folder in directory){
        
        # eliminar doble // en la ruta (para evitar errores)
        folder <- gsub("//", "/", folder)
        
        # extraemos el nombre de los archivos .xlsx (OJO, asegúrate de que solo tienes ahí los resultados de SIMANFOR)
        files_list <- list.files(path = folder, pattern="xlsx")
        
        # ahora accedemos a cada uno de los archivos...
        for(doc in files_list) {
                
          # leemos la información de la hoja "Parcelas" de cada archivo
          plot_data <- read_excel(path = paste(folder, "/", doc, sep = ""),
                                  sheet = "Parcelas")  
    
          # añadimos el nombre del archivo a la información de las parcelas            
          plot_data$Nombre_fichero_origen <- doc

          # añadimos la información a la variable "plots"
          ifelse(length(plots) == 0, plots <- rbind(plot_data), plots <- rbind(plots, plot_data))
        }
}
```

Ahora podemos echar un vistazo a nuestros datos para ver su contenido y eliminar las variables temporales que ya no 
vamos a necesitar. Si no sabes cual es el significado de alguna de las variables puedes consultar la hoja "Metadatos" 
de cualquiera de los archivos de resultados de SIMANFOR.

```{r}
# mostramos las primeras filas de la variable "plots"
head(plots)  

# eliminamos las variables temporales que ya no vamos a necesitar
rm(directory, doc, files_list, folder, plot_data, my_path)
```


## Preparación de datos: evolución de la masa

Ahora que ya tenemos los datos de SIMANFOR cargados en R, vamos a trabajar un poco con ellos. En primer lugar, vamos a 
preparar los datos para poder calcular la evolución de la masa de las parcelas a lo largo del tiempo. 
Comenzaremos por redondear la edad de las parcelas a múltiplos de 5 años (para simplificar visualmente los resultados) y
eliminaremos la primera línea de datos (Carga Inicial), puesto que contiene información incompleta del inventario 
inicial que es completada en la primera simulación (Inicialización).

```{r}
# vamos a copiar los datos para conservar los orginales
df <- plots

# las edades de las parcelas son muy diferentes, por lo que, para simplificar, vamos a agruparlas en grupos de edad de 5 años
redondeo <- function(x, base){  # esta función nos permitirá redondear la edad de la masa a múltiplos de 5 años
        base * round(x/base)
}                                 

# utilizamos la función anterior
df$T <- redondeo(df$T, 5)  

# eliminamos la primera línea de datos (Carga Inicial)
df <- df[!df$Accion == "Carga Inicial", ]  
```

Para identificar cada uno de los escenarios, vamos a extraer el código de escenario y crear una columna con su nombre. 
Debes escoger, en el nombre de los ficheros, la parte que identifique el ID de parcela.
Selecciona la opción que se corresponda con tu caso y elimina el resto de opciones. Si ninguna satisface tu caso, 
entonces modifica el código:

`substr(x, start, stop)`

- substr: función que extrae una subcadena de un vector de caracteres
- x: vector de caracteres
- start: posición de inicio de la subcadena (cuenta en nº de caracteres en donde comienza el código que quieres escoger)
- stop: posición de fin de la subcadena (cuenta en nº de caracteres en donde termina el código que quieres escoger)

```{r}
# selecciona la opción que se corresponda con tu caso:

# caso 1: estoy utilizando resultados obtenidos de la web de SIMANFOR (no los renombres)
#df$n_scnr <- substr(df$Nombre_fichero_origen, 38, 39)

# caso 2: estoy utilizando resultados de ejemplo de Ppinaster-Del_Rio_2006 
# obtenidos de https://github.com/simanfor/resultados/tree/main/Ppinaster-Del_Rio_2006
#df$n_scnr <- substr(df$Nombre_fichero_origen, 22, 23)

# caso 3: estoy utilizando resultados de ejemplo de Ps-no_maderables 
# obtenidos de https://github.com/simanfor/resultados/tree/main/Ps-no_maderables
df$n_scnr <- substr(df$Nombre_fichero_origen, 1, 4)

# caso 4: estoy utilizando resultados de ejemplo de alguna carpeta dentro de Qpyrenaica_masas_irregulares
# obtenidos de https://github.com/simanfor/resultados/tree/main/Qpyrenaica_masas_irregulares
#df$n_scnr <- substr(df$Nombre_fichero_origen, 4, 11)

# caso 5: queremos como identificador de escenario el código de un determinado output de SIMANFOR web
#df$n_scnr <- substr(df$Nombre_fichero_origen, 0, 24)
```

Ya casi lo tienes, por último, vamos a eliminar campos de información vacíos y revisar qué valores tenemos de nombre
para nuestros escenarios (si quieres puedes cambiar el nombre)

```{r}
# eliminamos campos de información vacíos
df <- df[!is.na(df$n_scnr), ]

# revisamos qué valores tenemos de nombre para nuestros escenarios
unique(df$n_scnr)
```


## Cálculo de la evoluación promedio de las parcelas para cada escenario

Si has introducido en R información de varias parcelas, la siguiente parte del código te permitirá hacer la media para 
algunos de los valores más importantes a nivel de parcela

OJO! Abre tus datos y mira qué clasificación de productos tiene el modelo que has utilizado. En el segundo grupo de 
cálculo puedes activar algunos productos que aparecen silenciados por defecto. Si tienes los datos para calcular esos 
productos puedes sacar los valores promedio de parcela eliminando la "\#" que precede a la línea en la que están
escritos. Si no tienes los datos, déjalos silenciados.

```{r}
# calculamos la evolución promedio de las parcelas para cada escenario
mean_evo_by_scnr <- ddply(df, c('n_scnr', 'T'), summarise,  # agrupamos por nº de escenario y edad de parcela

                          # ahora calcularemos algunas variables generales...                          
                          N = mean(N, na.rm = TRUE),  # calculamos la densidad media                    
                          dg = mean(dg, na.rm = TRUE),  # diámetro medio cuadrático
                          Ho = mean(Ho, na.rm = TRUE),  # altura dominante
                          V = mean(V_con_corteza, na.rm = TRUE),  # volumen
                          WT = mean(WT, na.rm = TRUE),  # biomasa total
                          G = mean(G, na.rm = TRUE),  # área basimétrica
                          
                          # y la clasificación de productos
                          #V_desenrollo = mean(V_desenrollo, na.rm = TRUE),  # volumen desenrollo
                          #V_chapa = mean(V_chapa, na.rm = TRUE),  # volumen chapa
                          V_sierra_gruesa = mean(V_sierra_gruesa, na.rm = TRUE),  # volumen sierra gruesa
                          V_sierra = mean(V_sierra, na.rm = TRUE),  # volumen sierra
                          V_sierra_canter = mean(V_sierra_canter, na.rm = TRUE),  # volumen sierra cánter
                          #V_postes = mean(V_postes, na.rm = TRUE),  # volumen postes
                          #V_estacas = mean(V_estacas, na.rm = TRUE),  # volumen estacas
                          V_trituracion = mean(V_trituracion, na.rm = TRUE)  # volumen trituración
)
```

## Graficar resultados: Densidad y área basimétrica

Ahora que ya tenemos los datos que necesitamos, vamos a hacer unos gráficos que nos muestren la evolución de la parcela 
bajo distintos escenarios selvícolas. Para ello utilizaremos la librería ggplot2

```{r}
# Densidad de la masa

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = N,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución de la densidad de la masa",  # título
       # subtitle = "",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Densidad (pies/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
```

```{r}
# Área basimétrica de la masa

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = G,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
        
       # ponemos las etiquetas   
       labs(title = "Evolución del Área basimétrica de la masa",  # título
             # subtitle = "",  # subtítulo
             x = "Edad de la masa (años)",  # eje x
             y = "Área basimétrica (m2/ha)"  # eje y 
        ) +
        
        # modificamos las etiquetas
        theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                      hjust = 0.5),  # centramos título
              plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                         hjust = 0.5),  # centramos subtítulo
              axis.title = element_text(size = 12),  # tamaño ejes
              legend.title = element_text(size = 12),  # tamaño título leyenda
              legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
              
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda

        # y dibujamos lo datos
        geom_point() +  # nube de puntos
        #geom_smooth(method='lm', )  # regresión lineal
        geom_line()  # línea uniendo puntos
```

```{r}
# Área basimétrica del árbol

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = G/N,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del Área basimétrica del árbol promedio",  # título
       # subtitle = "",  # subtítulo
       x = "Edad del árbol (años)",  # eje x
       y = "Área basimétrica (m2)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
```

## Graficar resultados: Volúmenes comerciales

Antes de lanzarte a hacer los gráficos, revisa qué variables tienes disponibles en tus resultados. Si alguno de los
gráficos no te funciona será por falta de datos.

```{r}
# Volumen de desenrollo de la masa (si está disponible)

# comprobar si la variable está en el dataframe para dibujar el gráfico
variable <- 'V_desenrollo'
if(variable %in% colnames(mean_evo_by_scnr)){
  
  ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
         
         # selección de variables
         aes(x = T, y = V_desenrollo,  # eje X e Y
             group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
    
    # ponemos las etiquetas   
    labs(title = "Evolución del volumen de desenrollo de la masa",  # título
         # subtitle = "",  # subtítulo
         x = "Edad de la masa (años)",  # eje x
         y = "Volumen desenrollo (m3/ha)"  # eje y 
    ) +
    
    # modificamos las etiquetas
    theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                  hjust = 0.5),  # centramos título
          plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                     hjust = 0.5),  # centramos subtítulo
          axis.title = element_text(size = 12),  # tamaño ejes
          legend.title = element_text(size = 12),  # tamaño título leyenda
          legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
    
    # modificamos la leyenda
    scale_color_discrete('Escenario') +  # damos nombre a la leyenda
    
    # y dibujamos lo datos
    geom_point() +  # nube de puntos
    #geom_smooth(method='lm', )  # regresión lineal
    geom_line()  # línea uniendo puntos

} else {
  print(paste('La variable ', variable, 'no está disponible en tus datos', 
              sep = ''))
  }
```

```{r}
# Volumen de chapa de la masa

# comprobar si la variable está en el dataframe para dibujar el gráfico
variable <- 'V_chapa'
if(variable %in% colnames(mean_evo_by_scnr)){

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = V_chapa,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del volumen de chapa de la masa",  # título
       # subtitle = "",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Volumen chapa (m3/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
  
} else {
  print(paste('La variable ', variable, 'no está disponible en tus datos', 
              sep = ''))
  }
```

```{r}
# Volumen de sierra gruesa de la masa

# comprobar si la variable está en el dataframe para dibujar el gráfico
variable <- 'V_sierra_gruesa'
if(variable %in% colnames(mean_evo_by_scnr)){

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = V_sierra_gruesa,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del volumen de sierra gruesa de la masa",  # título
       # subtitle = "",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Volumen sierra gruesa (m3/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
  
} else {
  print(paste('La variable ', variable, 'no está disponible en tus datos', 
              sep = ''))
  }
```

```{r}
# Volumen de sierra cánter de la masa

# comprobar si la variable está en el dataframe para dibujar el gráfico
variable <- 'V_sierra_canter'
if(variable %in% colnames(mean_evo_by_scnr)){

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = V_sierra_canter,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del volumen de sierra cánter de la masa",  # título
       # subtitle = "",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Volumen sierra cánter (m3/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
  
} else {
  print(paste('La variable ', variable, 'no está disponible en tus datos', 
              sep = ''))
  }
```

```{r}
# Volumen de sierra de la masa

# comprobar si la variable está en el dataframe para dibujar el gráfico
variable <- 'V_sierra'
if(variable %in% colnames(mean_evo_by_scnr)){

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = V_sierra,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del volumen de sierra de la masa",  # título
       # subtitle = "",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Volumen sierra (m3/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
  
} else {
  print(paste('La variable ', variable, 'no está disponible en tus datos', 
              sep = ''))
  }
```

```{r}
# Volumen de postes de la masa

# comprobar si la variable está en el dataframe para dibujar el gráfico
variable <- 'V_postes'
if(variable %in% colnames(mean_evo_by_scnr)){

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = V_postes,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del volumen de postes de la masa",  # título
       # subtitle = "",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Volumen postes (m3/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
  
} else {
  print(paste('La variable ', variable, 'no está disponible en tus datos', 
              sep = ''))
  }
```

```{r}
# Volumen de estacas de la masa

# comprobar si la variable está en el dataframe para dibujar el gráfico
variable <- 'V_estacas'
if(variable %in% colnames(mean_evo_by_scnr)){

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = V_estacas,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del volumen de estacas de la masa",  # título
       # subtitle = "",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Volumen estacas (m3/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
  
} else {
  print(paste('La variable ', variable, 'no está disponible en tus datos', 
              sep = ''))
  }
```

```{r}
# Volumen de trituración de la masa

# comprobar si la variable está en el dataframe para dibujar el gráfico
variable <- 'V_trituracion'
if(variable %in% colnames(mean_evo_by_scnr)){

ggplot(mean_evo_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = T, y = V_trituracion,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del volumen de trituración de la masa",  # título
       # subtitle = "",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Volumen trituración (m3/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # y dibujamos lo datos
  geom_point() +  # nube de puntos
  #geom_smooth(method='lm', )  # regresión lineal
  geom_line()  # línea uniendo puntos
  
} else {
  print(paste('La variable ', variable, 'no está disponible en tus datos', 
              sep = ''))
  }
```


## Preparación de datos: madera acumulada

Para este caso, vamos a trabajar con el volumen total y el área basimétrica de la parcela. Para ello, verás que 
repetimos los mismos cálculos para las dos variables. Puedes añadir más si lo necesitas.

```{r}
# reutilizo los datos iniciales
df_2 <- plots  

# extraigo información de las cortas y de las ejecuciones
cortas <- filter(df_2, Accion == "Corta")
crecimientos <- filter(df_2, Accion == "Ejecución")  

# me quedo únicamente con el valor del último crecimiento
crecimiento_final <- crecimientos[crecimientos$Edad_de_escenario == max(crecimientos$Edad_de_escenario), ]

# elimino procesos de corta en los que no se extrae nada
cortas <- filter(cortas, !is.na(V_extraido))
cortas <- filter(cortas, V_extraido != 0)  

# calculo el volumen y área basimétrica de la corta en cada proceso
cortas$v_cortado <- cortas$V_con_corteza * cortas$V_extraido / (100 - cortas$V_extraido) 
cortas$g_cortada <- cortas$G * cortas$G_extraida / (100 - cortas$G) 

# sumo los datos de las cortas
cortas <- ddply(cortas, c('Nombre_fichero_origen'), summarise,  # agrupo filas por código de escenario
              v_cortado_sum = sum(v_cortado, na.rm = TRUE),  # sumo el volumen cortado en cada parcela
              g_cortada_sum = sum(g_cortada, na.rm = TRUE)  # sumo el Área basimétrica cortada en cada parcela
)  

# uno ambas bases de datos, cortas y ejecuciones
final_plots <- merge(crecimiento_final, cortas, by = 'Nombre_fichero_origen', all = TRUE)

# para evitar celdas vacías, le doy a estas el valor 0 (evitar errores de cálculo)
final_plots[is.na(final_plots)] <- 0  

# calculo el volumen final (cortado y en pie)
final_plots$Vfinal <- final_plots$V_con_corteza + final_plots$v_cortado_sum  

# calculo el área basimétrica final (cortado y en pie)
final_plots$Gfinal <- final_plots$G + final_plots$g_cortada_sum  

# elimino variables temporales
rm(cortas, crecimientos, crecimiento_final, df_2, variable)  
```

Para identificar cada uno de los escenarios, vamos a extraer el nº de escenario y crear una columna con su valor.
Selecciona la opción que se corresponda con tu caso y elimina el resto
de opciones. Si ninguna satisface tu caso, entonces modifica el código:

`substr(x, start, stop)`

- substr: función que extrae una subcadena de un vector de caracteres
- x: vector de caracteres
- start: posición de inicio de la subcadena (cuenta en nº de caracteres en donde comienza el código que quieres escoger)
- stop: posición de fin de la subcadena (cuenta en nº de caracteres en donde termina el código que quieres escoger)

```{r}
# selecciona la opción que se corresponda con tu caso:

# caso 1: estoy utilizando resultados obtenidos de la web de SIMANFOR (no los renombres, es importante para diferenciarlos)
#final_plots$Escenario <- substr(final_plots$Nombre_fichero_origen, 38, 39)

# caso 2: estoy utilizando resultados de ejemplo de Ppinaster-Del_Rio_2006 obtenidos de https://github.com/simanfor/resultados/tree/main/Ppinaster-Del_Rio_2006
#final_plots$Escenario <- substr(final_plots$Nombre_fichero_origen, 22, 23)

# caso 3: estoy utilizando resultados de ejemplo de Ps-no_maderables obtenidos de https://github.com/simanfor/resultados/tree/main/Ps-no_maderables
final_plots$Escenario <- substr(final_plots$Nombre_fichero_origen, 1, 4)

# caso 4: estoy utilizando resultados de ejemplo de alguna carpeta dentro de Qpyrenaica_masas_irregulares
# obtenidos de https://github.com/simanfor/resultados/tree/main/Qpyrenaica_masas_irregulares
#final_plots$Escenario <- substr(final_plots$Nombre_fichero_origen, 4, 11)

# caso 5: queremos como identificador de escenario el código de un determinado output de SIMANFOR web
#final_plots$Escenario <- substr(final_plots$Nombre_fichero_origen, 0, 24)
```

Hacemos los cálculos promedio para todas las parcelas que hemos simulado bajo un mismo escenario.

```{r}
# calculamos ahora el promedio, por escenario, de volumen y Área basimétrica acumulada
mean_acum_by_scnr <- ddply(final_plots, c('Escenario'), summarise,  # agrupamos por código de escenario
                           V_acum = mean(Vfinal, na.rm = TRUE),  # volumen acumulado por escenario
                           G_acum = mean(Gfinal, na.rm = TRUE))  # Área basimétrica acumulada por escenario
```

## Graficar resultados: Área basimétrica y Volumen acumulado

```{r}
# Área basimétrica de la masa

ggplot(mean_acum_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = Escenario, y = G_acum,  # eje X e Y
           fill = Escenario)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Área basimétrica acumulada durante el escenario",  # título
       # subtitle = "",  # subtítulo
       x = "",  # eje x 
       y = "Área basimétrica (m2/ha)"  # eje y       
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # y dibujamos lo datos
  geom_bar(stat="identity")  # barras
```

```{r}
# Volumen de la masa

ggplot(mean_acum_by_scnr,  # seleccionamos los datos a utilizar 
       
       # selección de variables
       aes(x = Escenario, y = V_acum,  # eje X e Y
           fill = Escenario)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Volumen acumulado durante el escenario",  # título
       # subtitle = "",  # subtítulo
       x = "",  # eje x 
       y = "Volumen (m3/ha)"  # eje y       
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle = element_text(size = 12,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # y dibujamos lo datos
  geom_bar(stat="identity")  # barras
```


## Preparación de datos: madera total del itinerario selvícola (en pie y extraída/muerta)

Trabajemos ahora con los datos de madera total del itinerario selvícola. En el caso anterior únicamente sumamos los
valores de volumen y área basimétrica extraído a los datos de la masa que permanece en pie. Ahora vamos a hacerlo de 
manera más fina, calculando las diferencias entre cada uno de los pasos marcados en el escenario para las variables 
deseadas. Puedes añadir o eliminar variables según tus necesidades, solo tienes que tener en cuenta que las variables
han de estar en tu archivo de resultados (cada modelo devuelve variables diferentes).

```{r}
# reutilizamos df inicial
df_3 <- plots 

# eliminamos la acción de carga inicial
df_3 <- df_3[!df_3$Accion == "Carga Inicial", ]
```

Ahora calculamos las diferencias entre cada uno de los pasos marcados en el escenario selvícola para las variables 
deseadas. Puedes añadir o eliminar variables según tus necesidades, solo tienes que tener en cuenta que las variables 
han de estar en tu archivo de resultados (cada modelo devuelve variables diferentes).

```{r}
# para los resultados de nuestros itinerarios
df_3 <- df_3 %>%
  
  # agrupamos datos por nombre de fichero y escenario
  group_by(Nombre_fichero_origen, Nombre_archivo_escenario) %>%
  
  # creamos una columna nueva por cada variable que queramos analizar
  mutate(V_diff = V_con_corteza - lag(V_con_corteza),
         WSW_diff = WSW - lag(WSW),
         WR_diff = WR - lag(WR),
         WT_diff = WT - lag(WT)
  # AQUÍ PUEDES AÑADIR MÁS VARIABLES SI LO DESEAS, INTENTA MANTENER EL MISMO FORMATO EN LOS NOMBRE PARA EVITAR ERRORES
)
```

Calculadas las diferencias, ahora vamos a calcular los valores acumulados para cada una de las variables, es decir, 
la suma del valor que representan los árboles en pie y los árboles cortados.

```{r}
# creamos un nuevo df con los valores acumulados
new_df_3 <- tibble()

# para cada escenario...
for(scnr in unique(df_3$Nombre_archivo_escenario)){
  
  # filtramos sus datos
  scnr <- df_3[df_3$Nombre_archivo_escenario == scnr, ]
  
  # para cada parcela simulada con el escenario...
  for(plot in unique(scnr$Nombre_fichero_origen)){
    
    # filtramos los datos
    plot <- scnr[scnr$Nombre_fichero_origen == plot, ]
    
    # establecemos los valores para las variables que queremos calcular como 0
    all_V <- all_WSW <- all_WR <- all_WT <- 0
    
    # para cada paso del escenario selvícola...
    for(row in 1:nrow(plot)){
      
      # seleccionamos los datos
      new_row <- plot[row, ]
      
      # para la primera fila 1, tomamos de referencia el valor inicial
      if(row == 1){
        
        # copiamos el valor inicial de la parcela
        all_V <- new_row$V_con_corteza
        all_WSW <- new_row$WSW
        all_WR <- new_row$WR
        all_WT <- new_row$WT
    # AQUÍ PUEDES AÑADIR MÁS VARIABLES SI LO DESEAS, INTENTA MANTENER EL MISMO FORMATO EN LOS NOMBRE PARA EVITAR ERRORES
        
        # y añadimos el valor a una nueva columna
        new_row$V_all <- all_V
        new_row$WSW_all <- all_WSW
        new_row$WR_all <- all_WR
        new_row$WT_all <- all_WT
    # AQUÍ PUEDES AÑADIR MÁS VARIABLES SI LO DESEAS, INTENTA MANTENER EL MISMO FORMATO EN LOS NOMBRE PARA EVITAR ERRORES
        
      # si es cualquier otra fila de nuestros datos, entonces añadimos la diferencia entre filas en valor absoluto abs()
      } else {
        
        # calculamos el incremento respecto al valor anterior
        all_V <- all_V + abs(new_row$V_diff)
        all_WSW <- all_WSW + abs(new_row$WSW_diff)
        all_WR <- all_WR + abs(new_row$WR_diff)
        all_WT <- all_WT + abs(new_row$WT_diff)
    # AQUÍ PUEDES AÑADIR MÁS VARIABLES SI LO DESEAS, INTENTA MANTENER EL MISMO FORMATO EN LOS NOMBRE PARA EVITAR ERRORES
        # añadimos el valor a la columna correspondiente
        new_row$V_all <- all_V
        new_row$WSW_all <- all_WSW
        new_row$WR_all <- all_WR
        new_row$WT_all <- all_WT
    # AQUÍ PUEDES AÑADIR MÁS VARIABLES SI LO DESEAS, INTENTA MANTENER EL MISMO FORMATO EN LOS NOMBRE PARA EVITAR ERRORES

    }
      
      # añadimos la fila a nuestro nuevo df
      new_df_3 <- rbind(new_df_3, new_row)
      
    } # fila de datos
  } # parcela
} # escenario
```

Por último, retocamos los datos: redondeamos las edades, obtenemos el código de escenario y eliminamos las filas vacías.

```{r}
# redondeamos la edad
new_df_3$T <- redondeo(new_df_3$T, 5) 

#-#-#-#-#-#-#-#-#-#-

# obtenemos el código de escenario

# selecciona la opción que se corresponda con tu caso:
# caso 1: estoy utilizando resultados obtenidos de la web de SIMANFOR (no los renombres, es importante para diferenciarlos)
#new_df_3$n_scnr <- substr(new_df_3$Nombre_fichero_origen, 38, 39)

# caso 2: estoy utilizando resultados de ejemplo de Ppinaster-Del_Rio_2006 obtenidos de https://github.com/simanfor/resultados/tree/main/Ppinaster-Del_Rio_2006
#new_df_3$n_scnr <- substr(new_df_3$Nombre_fichero_origen, 22, 23)

# caso 3: estoy utilizando resultados de ejemplo de Ps-no_maderables obtenidos de https://github.com/simanfor/resultados/tree/main/Ps-no_maderables
new_df_3$n_scnr <- substr(new_df_3$Nombre_fichero_origen, 1, 4)

# caso 4: estoy utilizando resultados de ejemplo de alguna carpeta dentro de Qpyrenaica_masas_irregulares
# obtenidos de https://github.com/simanfor/resultados/tree/main/Qpyrenaica_masas_irregulares
#new_df_3$n_scnr <- substr(new_df_3$Nombre_fichero_origen, 4, 11)

# caso 5: queremos como identificador de escenario el código de un determinado output de SIMANFOR web
#new_df_3$n_scnr <- substr(new_df_3$Nombre_fichero_origen, 0, 24)

#-#-#-#-#-#-#-#-#-#-

# eliminamos filas vacías
new_df_3 <- new_df_3[!is.na(new_df_3$n_scnr), ]

# eliminamos variables temporales
rm(scnr, plot, all_V, all_WSW, all_WR, all_WT, new_row, row, df_3)
```

Por último, calculamos los valores medios por escenario y año para las variables deseadas.

```{r}
# valores medios por escenario y año
stand_evolution <- ddply(new_df_3, c('n_scnr', 'T'), summarise, 
                          
    # variables generales para los árboles en pie
    N = mean(N, na.rm = TRUE),                  
    dg = mean(dg, na.rm = TRUE),
    G = mean(G, na.rm = TRUE),
    Ho = mean(Ho, na.rm = TRUE),  
    V = mean(V_con_corteza, na.rm = TRUE), 
    WSW = mean(WSW, na.rm = TRUE),
    WR = mean(WR, na.rm = TRUE),
    WT = mean(WT, na.rm = TRUE), 
    
    # variables para los árboles cortados y en pie               
    V_all = mean(V_all, na.rm = TRUE), 
    WSW_all = mean(WSW_all, na.rm = TRUE),
    WR_all = mean(WR_all, na.rm = TRUE),
    WT_all = mean(WT_all, na.rm = TRUE)
   # AQUÍ PUEDES AÑADIR MÁS VARIABLES SI LO DESEAS, INTENTA MANTENER EL MISMO FORMATO EN LOS NOMBRE PARA EVITAR ERRORES
)
```

## Graficar resultados: producción total durante el escenario selvícola (madera en pie + extraída)

Antes de lanzarte a hacer los gráficos, revisa qué variables tienes disponibles en tus resultados. Puedes copiar y pegar
el código para dibujar nuevas variables si lo necesitas.

```{r}
# Volumen con corteza

ggplot(stand_evolution,  # seleccionamos los datos a utilizar 
       
  # selección de variables
  aes(x = T, y = V_all,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución del volumen total de la masa",  # título
       subtitle = "Línea sólida y puntos para el volumen total; línea discontinua para volumen en pie",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Volumen (m3/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle=element_text(size = 10,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # dibujamos lo datos
  geom_point() +  # nube de puntos
  geom_line(linetype = 'solid') +  # línea uniendo puntos
  
  # añadimos la línea de volumen en pie para comparar
  geom_line(aes(y = V), linetype = "dashed") +  # línea punteada para el volumen en pie
  
  # incluimos la leyenda
  theme(legend.position = "bottom")  # posición de la leyenda

```

```{r}
# Biomasa del tronco

ggplot(stand_evolution,  # seleccionamos los datos a utilizar 
       
  # selección de variables
  aes(x = T, y = WSW_all,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución de la biomasa del tronco en la masa",  # título
       subtitle = "Línea sólida y puntos para la biomasa total; línea discontinua para la biomasa en pie",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Biomasa (Tn/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle=element_text(size = 10,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # dibujamos lo datos
  geom_point() +  # nube de puntos
  geom_line(linetype = 'solid') +  # línea uniendo puntos
  
  # añadimos la línea de volumen en pie para comparar
  geom_line(aes(y = WSW), linetype = "dashed") +  # línea punteada para el volumen en pie
  
  # incluimos la leyenda
  theme(legend.position = "bottom")  # posición de la leyenda

```

```{r}
# Biomasa de las raíces

ggplot(stand_evolution,  # seleccionamos los datos a utilizar 
       
  # selección de variables
  aes(x = T, y = WR_all,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución de la biomasa de las raíces en la masa",  # título
       subtitle = "Línea sólida y puntos para la biomasa total; línea discontinua para la biomasa en pie",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Biomasa (Tn/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle=element_text(size = 10,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # dibujamos lo datos
  geom_point() +  # nube de puntos
  geom_line(linetype = 'solid') +  # línea uniendo puntos
  
  # añadimos la línea de volumen en pie para comparar
  geom_line(aes(y = WR), linetype = "dashed") +  # línea punteada para el volumen en pie
  
  # incluimos la leyenda
  theme(legend.position = "bottom")  # posición de la leyenda

```

```{r}
# Biomasa total

ggplot(stand_evolution,  # seleccionamos los datos a utilizar 
       
  # selección de variables
  aes(x = T, y = WT_all,  # eje X e Y
           group = n_scnr, colour = n_scnr)) +  # agrupamos por tipo de escenario, asignando un color distinto a cada uno
  
  # ponemos las etiquetas   
  labs(title = "Evolución de la biomasa total en la masa",  # título
       subtitle = "Línea sólida y puntos para la biomasa total; línea discontinua para la biomasa en pie",  # subtítulo
       x = "Edad de la masa (años)",  # eje x
       y = "Biomasa (Tn/ha)"  # eje y 
  ) +
  
  # modificamos las etiquetas
  theme(plot.title = element_text(size = 15,  # cambiamos el tamaño del título
                                hjust = 0.5),  # centramos título
        plot.subtitle=element_text(size = 10,  # tamaño subtítulo
                                   hjust = 0.5),  # centramos subtítulo
        axis.title = element_text(size = 12),  # tamaño ejes
        legend.title = element_text(size = 12),  # tamaño título leyenda
        legend.text = element_text(size = 12)) +  # tamaño contenido leyenda
  
  # modificamos la leyenda
  scale_color_discrete('Escenario') +  # damos nombre a la leyenda
  
  # dibujamos lo datos
  geom_point() +  # nube de puntos
  geom_line(linetype = 'solid') +  # línea uniendo puntos
  
  # añadimos la línea de volumen en pie para comparar
  geom_line(aes(y = WT), linetype = "dashed") +  # línea punteada para el volumen en pie
  
  # incluimos la leyenda
  theme(legend.position = "bottom")  # posición de la leyenda

```
